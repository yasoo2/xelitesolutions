import{r,j as t,A as j}from"./index-BjnjHfFV.js";function be({wsUrl:w}){const k=r.useRef(null),K=r.useRef(null),[u,X]=r.useState({w:1280,h:800}),[$,C]=r.useState("connecting"),[b,Q]=r.useState(""),[A,V]=r.useState([]),[z,M]=r.useState(""),[L,Z]=r.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[O,R]=r.useState(null),[N,ee]=r.useState(""),D=r.useRef(null),[I,F]=r.useState(null),[T,te]=r.useState(!0),[S,U]=r.useState(""),[h,oe]=r.useState(""),[m,_]=r.useState(null),[y,re]=r.useState(""),[x,se]=r.useState(""),[J,ne]=r.useState(!0),[q,ae]=r.useState(!0),[H,le]=r.useState(!0),[P,ce]=r.useState("أضرار التدخين"),W=r.useRef(0);function E(){try{const s=new URL(w).pathname.split("/").filter(Boolean);return s[s.length-1]}catch{return""}}async function a(e){var l;const s=E();if(s)try{const i=localStorage.getItem("token"),d=await(await fetch(`${j}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:`Bearer ${i}`}:{}},body:JSON.stringify({sessionId:s,actions:e})})).json();if(Array.isArray(d.artifacts)){const o=d.artifacts.map(p=>({name:p.name||p.filename||"download",href:p.href}));V(p=>[...o,...p].slice(0,5))}if(d!=null&&d.ok&&Array.isArray((l=d==null?void 0:d.output)==null?void 0:l.outputs)){const o=d.output.outputs.find(p=>p.type==="locate"&&p.boundingBox);if(o!=null&&o.boundingBox&&(_(o.boundingBox),e.some(g=>g.type==="locate")&&q)){const c=[...e].reverse().find(f=>f.type==="locate")||null,v=[];if(c!=null&&c.selector)v.push({type:"click",selector:c.selector});else if(c!=null&&c.role&&(c!=null&&c.roleName))v.push({type:"click",role:c.role,roleName:c.roleName});else{const f=o.boundingBox;if(f){const xe=Math.round(f.x+f.width/2),ge=Math.round(f.y+f.height/2);v.push({type:"click",x:xe,y:ge})}}v.length&&setTimeout(()=>a(v),250);const he=!!(c!=null&&c.selector&&/input\[name=["']q["']\]/i.test(String(c.selector))),ye=!!(c!=null&&c.roleName&&String(c.roleName).includes("بحث"));H&&!S.trim()&&(he||ye)&&setTimeout(()=>{a([{type:"type",text:P,delay:30}]),setTimeout(()=>a([{type:"press",key:"Enter"}]),300)},400)}}const G=e.map(o=>o.type).join(", ");if(M(G),setTimeout(()=>M(""),1200),e.some(o=>o.type==="goto"||o.type==="reload")&&(_(null),J)){const o=[];if(h)o.push({type:"locate",selector:h});else if(y&&x)o.push({type:"locate",role:y,roleName:x});else{const p=e.find(g=>g.type==="goto");try{const g=p!=null&&p.url?new URL(p.url).hostname:"";g&&/(^|\.)(google)\./i.test(g)&&o.push({type:"locate",selector:'input[name="q"]'})}catch{}}o.length&&setTimeout(()=>a(o),1e3)}T&&e.some(o=>o.type==="press"&&o.key==="Enter")&&setTimeout(()=>{B()},2e3),T&&e.some(o=>o.type==="goto"||o.type==="reload")&&setTimeout(()=>{B()},1500)}catch{}}async function B(){const e=E();if(e)try{const s=localStorage.getItem("token"),l=JSON.parse(L),n=await(await fetch(`${j}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{}},body:JSON.stringify({sessionId:e,schema:l})})).json();n!=null&&n.ok&&(n!=null&&n.output)?R(n.output):R(null)}catch{R(null)}}async function ie(){var l,i;const e=E(),s=(i=(l=D.current)==null?void 0:l.files)==null?void 0:i[0];if(!(!e||!s||!N))try{const n=localStorage.getItem("token"),d=new FormData;d.append("file",s),d.append("sessionId",e);const o=await(await fetch(`${j}/files/upload`,{method:"POST",headers:{...n?{Authorization:`Bearer ${n}`}:{}},body:d})).json();if(o&&o._id){const p=`${j}/files/${o._id}/raw`;await a([{type:"uploadFile",selector:N,fileUrl:p}])}}catch{}}r.useEffect(()=>{try{const e=new WebSocket(w);return K.current=e,e.onopen=()=>C("connected"),e.onclose=()=>C("closed"),e.onmessage=s=>{try{const l=JSON.parse(s.data);if(l.type==="stream_start"&&X({w:l.w,h:l.h}),l.type==="frame"){const i=new Image;i.onload=()=>{const n=k.current;if(!n)return;n.width=u.w,n.height=u.h,n.getContext("2d").drawImage(i,0,0,u.w,u.h)},i.src="data:image/jpeg;base64,"+l.jpegBase64}}catch{}},()=>{try{e.close()}catch{}}}catch{C("error")}},[w,u.w,u.h]);function de(e){const s=k.current;if(!s)return;const l=s.getBoundingClientRect(),i=Math.round((e.clientX-l.left)*(u.w/l.width)),n=Math.round((e.clientY-l.top)*(u.h/l.height));a([{type:"click",x:i,y:n}]),F({x:i,y:n})}function ue(e){e.preventDefault();const s=Math.round(e.deltaY);a([{type:"scroll",deltaY:s}])}function pe(e){const s=Date.now();if(s-(W.current||0)<60)return;W.current=s;const l=k.current;if(!l)return;const i=l.getBoundingClientRect(),n=Math.round((e.clientX-i.left)*(u.w/i.width)),d=Math.round((e.clientY-i.top)*(u.h/i.height));F({x:n,y:d}),a([{type:"mouseMove",x:n,y:d,steps:2}])}function Y(){S.trim()&&(a([{type:"type",text:S,delay:30}]),U(""))}return t.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("button",{onClick:()=>a([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),t.jsx("button",{onClick:()=>a([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),t.jsx("button",{onClick:()=>a([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),t.jsx("input",{type:"text",value:b,onChange:e=>Q(e.target.value),onKeyDown:e=>{e.key==="Enter"&&b&&a([{type:"goto",url:b,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>b&&a([{type:"goto",url:b,waitUntil:"domcontentloaded"}]),className:"btn",title:"Go",children:"Go"}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:T,onChange:e=>te(e.target.checked)}),"Auto Extract"]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:$==="connected"?"#22c55e":"#f59e0b"}}),t.jsx("span",{style:{fontSize:12,opacity:.6},children:$}),!!z&&t.jsxs("span",{style:{fontSize:12,opacity:.8},children:["Joe: ",z]})]}),t.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:8,overflow:"hidden",position:"relative"},children:[t.jsx("canvas",{ref:k,onClick:de,onWheel:ue,onMouseMove:pe,style:{width:"100%",height:"auto",display:"block",background:"black",cursor:"crosshair"}}),m&&t.jsx("div",{style:{position:"absolute",left:`${m.x/u.w*100}%`,top:`${m.y/u.h*100}%`,width:`${m.width/u.w*100}%`,height:`${m.height/u.h*100}%`,border:"2px solid rgba(59,130,246,0.9)",boxShadow:"0 0 12px rgba(59,130,246,0.6)",pointerEvents:"none"},title:"Highlight"}),I&&t.jsx("div",{style:{position:"absolute",left:`${I.x/u.w*100}%`,top:`${I.y/u.h*100}%`,transform:"translate(-50%, -50%)",width:16,height:16,borderRadius:"50%",background:"rgba(34,197,94,0.8)",boxShadow:"0 0 12px rgba(34,197,94,0.8)",pointerEvents:"none"},title:"Cursor"})]}),A.length>0&&t.jsx("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:A.map((e,s)=>t.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"var(--text-primary)",textDecoration:"underline"},children:e.name},s))}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector for file input (e.g. input[type=file])",value:N,onChange:e=>ee(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"file",ref:D}),t.jsx("button",{onClick:ie,className:"btn",children:"Upload"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",value:S,onChange:e=>U(e.target.value),placeholder:"Type into focused element...",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"},onKeyDown:e=>{e.key==="Enter"&&Y()}}),t.jsx("button",{onClick:Y,className:"btn",children:"Type"}),t.jsx("button",{onClick:()=>a([{type:"press",key:"Enter"}]),className:"btn",children:"Enter"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector (مثال: input[name=q])",value:h,onChange:e=>oe(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>h&&a([{type:"locate",selector:h}]),className:"btn",children:"Locate"}),t.jsx("button",{onClick:()=>h&&a([{type:"click",selector:h}]),className:"btn",children:"اضغط المحدد"}),t.jsx("button",{onClick:()=>h&&a([{type:"scrollTo",selector:h}]),className:"btn",children:"Scroll إلى المحدد"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"role (مثال: button)",value:y,onChange:e=>re(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"text",placeholder:"name (مثال: بحث)",value:x,onChange:e=>se(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>y&&x&&a([{type:"locate",role:y,roleName:x}]),className:"btn",children:"Locate (role/name)"}),t.jsx("button",{onClick:()=>y&&x&&a([{type:"click",role:y,roleName:x}]),className:"btn",children:"اضغط (role/name)"}),t.jsx("button",{onClick:()=>y&&x&&a([{type:"waitForRole",role:y,roleName:x}]),className:"btn",children:"انتظر (role/name)"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:J,onChange:e=>ne(e.target.checked)}),"Auto Locate بعد التنقل"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:q,onChange:e=>ae(e.target.checked)}),"Auto Click بعد locate"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:H,onChange:e=>le(e.target.checked)}),"Auto Type بعد التركيز"]}),t.jsx("input",{type:"text",value:P,onChange:e=>ce(e.target.value),placeholder:"نص البحث الافتراضي",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("textarea",{value:L,onChange:e=>Z(e.target.value),placeholder:'{"list":{"selector":"table tr","fields":{"col1":{"selector":"td:nth-child(1)"}}}}',style:{flex:1,minHeight:80,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:B,className:"btn",children:"Extract"})]}),O&&t.jsx("pre",{style:{padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)",maxHeight:200,overflow:"auto"},children:JSON.stringify(O,null,2)})]})}export{be as default};

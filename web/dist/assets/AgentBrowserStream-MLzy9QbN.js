import{r as c,j as n,A as D}from"./index-UeumxsZZ.js";function Me({wsUrl:O}){const m=c.useRef(null),x=c.useRef(null),[f,Q]=c.useState({w:1280,h:800}),$=c.useRef({w:1280,h:800}),[T,S]=c.useState("connecting"),[P,k]=c.useState(""),[C,Z]=c.useState(""),[Y,ee]=c.useState([]),[J,v]=c.useState(""),[te,Se]=c.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[ke,U]=c.useState(null),[_,oe]=c.useState(""),X=c.useRef(null),[F,j]=c.useState(null),[R,ne]=c.useState(!0),[B,G]=c.useState(""),[b,re]=c.useState(""),[N,H]=c.useState(null),[K,ve]=c.useState(""),[V,je]=c.useState(""),[se,Te]=c.useState(!0),[ae,Ce]=c.useState(!0),[ce,Re]=c.useState(!0),[ie,Ne]=c.useState("أضرار التدخين"),I=c.useRef(0),z=c.useRef(null),A=c.useRef(null),E=c.useRef(0);c.useEffect(()=>{$.current=f},[f]);function L(){try{const a=new URL(O).pathname.split("/").filter(Boolean);return a[a.length-1]}catch{return""}}async function h(e){var t;const a=L();if(!a)return;const l=["mouseMove","click","scroll","type","press","goBack","goForward","reload"];if(x.current&&x.current.readyState===WebSocket.OPEN&&e.every(i=>l.includes(i.type))){e.forEach(d=>{var r;(r=x.current)==null||r.send(JSON.stringify({type:"action",action:d}))});const i=e.map(d=>d.type).join(", ");v(i),setTimeout(()=>v(""),1200),R&&e.some(d=>d.type==="press"&&d.key==="Enter")&&setTimeout(()=>W(),2e3),R&&e.some(d=>d.type==="reload")&&setTimeout(()=>W(),1500);return}try{const i=localStorage.getItem("token"),r=await(await fetch(`${D}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...i?{Authorization:`Bearer ${i}`}:{}},body:JSON.stringify({sessionId:a,actions:e})})).json();if(Array.isArray(r.artifacts)){const o=r.artifacts.map(p=>({name:p.name||p.filename||"download",href:p.href}));ee(p=>[...o,...p].slice(0,5))}if(r!=null&&r.ok&&Array.isArray((t=r==null?void 0:r.output)==null?void 0:t.outputs)){const o=r.output.outputs.find(p=>p.type==="locate"&&p.boundingBox);if(o!=null&&o.boundingBox&&(H(o.boundingBox),e.some(g=>g.type==="locate")&&ae)){const y=[...e].reverse().find(w=>w.type==="locate")||null,M=[];if(y!=null&&y.selector)M.push({type:"click",selector:y.selector});else if(y!=null&&y.role&&(y!=null&&y.roleName))M.push({type:"click",role:y.role,roleName:y.roleName});else{const w=o.boundingBox;if(w){const be=Math.round(w.x+w.width/2),we=Math.round(w.y+w.height/2);M.push({type:"click",x:be,y:we})}}M.length&&setTimeout(()=>h(M),250);const ge=!!(y!=null&&y.selector&&/(input|textarea)\[name=["']q["']\]/i.test(String(y.selector))),me=!!(y!=null&&y.roleName&&String(y.roleName).includes("بحث"));ce&&!B.trim()&&(ge||me)&&setTimeout(()=>{h([{type:"waitForSelector",selector:'input[name="q"], textarea[name="q"]',timeoutMs:8e3}]),setTimeout(()=>h([{type:"type",text:ie,delay:30}]),200),setTimeout(()=>h([{type:"press",key:"Enter"}]),300)},400)}}const u=e.map(o=>o.type).join(", ");if(v(u),setTimeout(()=>v(""),1200),e.some(o=>o.type==="goto"||o.type==="reload")&&(H(null),se)){const o=[];if(b)o.push({type:"locate",selector:b});else if(K&&V)o.push({type:"locate",role:K,roleName:V});else{const p=e.find(g=>g.type==="goto");try{const g=p!=null&&p.url?new URL(p.url).hostname:"";g&&/(^|\.)(google)\./i.test(g)&&o.push({type:"locate",selector:'input[name="q"], textarea[name="q"]'})}catch{}}o.length&&setTimeout(()=>h(o),1e3)}R&&e.some(o=>o.type==="press"&&o.key==="Enter")&&setTimeout(()=>{W()},2e3),R&&e.some(o=>o.type==="goto"||o.type==="reload")&&setTimeout(()=>{W()},1500)}catch{}}async function W(){const e=L();if(e)try{const a=localStorage.getItem("token"),l=JSON.parse(te),t=await(await fetch(`${D}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:`Bearer ${a}`}:{}},body:JSON.stringify({sessionId:e,schema:l})})).json();t!=null&&t.ok&&(t!=null&&t.output)?U(t.output):U(null)}catch{U(null)}}async function le(){var l,s;const e=L(),a=(s=(l=X.current)==null?void 0:l.files)==null?void 0:s[0];if(!(!e||!a||!_))try{const t=localStorage.getItem("token"),i=new FormData;i.append("file",a),i.append("sessionId",e);const r=await(await fetch(`${D}/files/upload`,{method:"POST",headers:{...t?{Authorization:`Bearer ${t}`}:{}},body:i})).json();if(r&&r._id){const u=`${D}/files/${r._id}/raw`;await h([{type:"uploadFile",selector:_,fileUrl:u}])}}catch{}}c.useEffect(()=>{let e=!1;E.current=0,S("connecting"),k("");const a=()=>{z.current!=null&&(window.clearTimeout(z.current),z.current=null),A.current!=null&&(window.clearTimeout(A.current),A.current=null)},l=()=>{if(!e){a();try{if(x.current){try{x.current.close()}catch{}x.current=null}const s=new WebSocket(O);x.current=s,S(E.current>0?"reconnecting":"connecting"),A.current=window.setTimeout(()=>{try{s.readyState!==WebSocket.OPEN&&s.close()}catch{}},8e3),s.onopen=()=>{a(),!e&&(E.current=0,k(""),S("connected"))},s.onclose=t=>{if(a(),e)return;x.current=null;const i=8,d=E.current+1;if(E.current=d,d>i){S("error");const g=t!=null&&t.reason?` reason=${t.reason}`:"";k(`WebSocket closed (code=${(t==null?void 0:t.code)??"unknown"}${g})`);return}const r=Math.min(8e3,500*Math.pow(2,d-1)),u=Math.floor(Math.random()*250),o=r+u;S("reconnecting");const p=t!=null&&t.reason?` reason=${t.reason}`:"";k(`WebSocket closed (code=${(t==null?void 0:t.code)??"unknown"}${p}). retrying...`),z.current=window.setTimeout(l,o)},s.onerror=()=>{e||k("WebSocket error")},s.onmessage=t=>{var i,d;try{const r=JSON.parse(t.data);if(r.type==="stream_start"){const u={w:r.w,h:r.h};$.current=u,Q(u)}if(r.type==="cursor_move"&&j({x:r.x,y:r.y}),r.type==="cursor_click"){j({x:r.x,y:r.y});const u=document.createElement("div"),o=$.current;u.style.cssText=`
                position: absolute;
                left: ${r.x/o.w*100}%;
                top: ${r.y/o.h*100}%;
                width: 20px; height: 20px;
                background: rgba(255, 0, 0, 0.5);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                pointer-events: none;
                z-index: 100;
                transition: opacity 0.5s;
              `,(d=(i=m.current)==null?void 0:i.parentElement)==null||d.appendChild(u),setTimeout(()=>u.remove(),500)}if(r.type==="action_start"){const u=r.action;let o=u.type;u.type==="goto"&&(o=`Opening ${new URL(u.url).hostname}...`),u.type==="type"&&(o="Typing..."),u.type==="click"&&(o="Clicking..."),u.type==="scroll"&&(o="Scrolling..."),u.type==="screenshot"&&(o="Capturing View..."),v(o)}if(r.type==="action_done"&&setTimeout(()=>v(""),500),r.type==="frame"){const u=new Image;u.onload=()=>{const o=m.current;if(!o)return;const p=$.current;o.width=p.w,o.height=p.h,o.getContext("2d").drawImage(u,0,0,p.w,p.h)},u.src="data:image/jpeg;base64,"+r.jpegBase64}}catch{}}}catch(s){S("error"),k(String((s==null?void 0:s.message)||s))}}};return l(),()=>{var s;e=!0,a();try{(s=x.current)==null||s.close()}catch{}x.current=null}},[O]);function ue(e){const a=m.current;if(!a)return;const l=a.getBoundingClientRect(),s=Math.round((e.clientX-l.left)*(f.w/l.width)),t=Math.round((e.clientY-l.top)*(f.h/l.height));h([{type:"click",x:s,y:t}]),j({x:s,y:t})}function de(e){e.preventDefault();const a=Math.round(e.deltaY);h([{type:"scroll",deltaY:a}])}function pe(e){const a=Date.now();if(a-(I.current||0)<60)return;I.current=a;const l=m.current;if(!l)return;const s=l.getBoundingClientRect(),t=Math.round((e.clientX-s.left)*(f.w/s.width)),i=Math.round((e.clientY-s.top)*(f.h/s.height));j({x:t,y:i}),h([{type:"mouseMove",x:t,y:i,steps:2}])}function he(e){var d;const a=m.current,l=(d=e.touches)==null?void 0:d[0];if(!a||!l)return;e.preventDefault();const s=a.getBoundingClientRect(),t=Math.round((l.clientX-s.left)*(f.w/s.width)),i=Math.round((l.clientY-s.top)*(f.h/s.height));h([{type:"click",x:t,y:i}]),j({x:t,y:i})}function ye(e){var r;const a=Date.now();if(a-(I.current||0)<60)return;I.current=a;const l=m.current,s=(r=e.touches)==null?void 0:r[0];if(!l||!s)return;e.preventDefault();const t=l.getBoundingClientRect(),i=Math.round((s.clientX-t.left)*(f.w/t.width)),d=Math.round((s.clientY-t.top)*(f.h/t.height));j({x:i,y:d}),h([{type:"mouseMove",x:i,y:d,steps:2}])}function fe(){B.trim()&&(h([{type:"type",text:B,delay:30}]),G(""))}const[q,xe]=c.useState(!1);return n.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8,position:"relative"},children:[n.jsxs("div",{className:"agent-browser-header",style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",background:"var(--bg-secondary)",borderRadius:8,gap:8,flexWrap:"wrap"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:T==="connected"?"#22c55e":T==="reconnecting"?"#f59e0b":"#ef4444",boxShadow:T==="connected"?"0 0 8px #22c55e":"none"}}),n.jsx("span",{style:{fontSize:14,fontWeight:500,color:"var(--text-primary)"},children:T==="connected"?"Agent Connected":T}),P?n.jsx("span",{style:{fontSize:12,color:"var(--text-secondary)"},dir:"auto",children:P}):null]}),J&&n.jsxs("div",{style:{padding:"4px 12px",background:"rgba(59, 130, 246, 0.15)",border:"1px solid rgba(59, 130, 246, 0.3)",borderRadius:16,color:"#60a5fa",fontSize:12,display:"flex",alignItems:"center",gap:6},children:[n.jsx("span",{className:"animate-pulse",children:"●"}),J]}),n.jsx("button",{onClick:()=>xe(!q),style:{background:"transparent",border:"none",color:"var(--text-secondary)",cursor:"pointer",fontSize:12},children:q?"Hide Controls":"Show Controls"})]}),n.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:12,overflow:"hidden",position:"relative",background:"#000",boxShadow:"0 4px 20px rgba(0,0,0,0.3)"},children:[n.jsx("canvas",{ref:m,onClick:ue,onWheel:de,onMouseMove:pe,onTouchStart:he,onTouchMove:ye,style:{width:"100%",height:"auto",display:"block",cursor:"default",touchAction:"none"}}),N&&n.jsx("div",{style:{position:"absolute",left:`${N.x/f.w*100}%`,top:`${N.y/f.h*100}%`,width:`${N.width/f.w*100}%`,height:`${N.height/f.h*100}%`,border:"2px solid #eab308",boxShadow:"0 0 15px rgba(234, 179, 8, 0.4)",pointerEvents:"none",borderRadius:4,transition:"all 0.2s ease"}}),F&&n.jsx("div",{style:{position:"absolute",left:`${F.x/f.w*100}%`,top:`${F.y/f.h*100}%`,transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:50,transition:"all 0.1s linear"},children:n.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#eab308",border:"2px solid white",boxShadow:"0 2px 4px rgba(0,0,0,0.3)"}})})]}),Y.length>0&&n.jsxs("div",{style:{display:"flex",gap:8,padding:8,background:"var(--bg-secondary)",borderRadius:8},children:[n.jsx("span",{style:{fontSize:12,color:"var(--text-secondary)"},children:"Downloads:"}),Y.map((e,a)=>n.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"#3b82f6"},children:e.name},a))]}),q&&n.jsxs("div",{style:{padding:12,border:"1px solid var(--border-color)",borderRadius:8,background:"var(--bg-secondary)",display:"flex",flexDirection:"column",gap:12},children:[n.jsxs("div",{className:"agent-browser-controls-row",style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsx("button",{onClick:()=>h([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),n.jsx("button",{onClick:()=>h([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),n.jsx("button",{onClick:()=>h([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),n.jsx("input",{type:"text",value:C,onChange:e=>Z(e.target.value),onKeyDown:e=>{e.key==="Enter"&&C&&h([{type:"goto",url:C,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,minWidth:220,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-primary)",color:"var(--text-primary)"}}),n.jsx("button",{onClick:()=>C&&h([{type:"goto",url:C,waitUntil:"domcontentloaded"}]),className:"btn",children:"Go"})]}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:8},children:[n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",placeholder:"Upload Selector",value:_,onChange:e=>oe(e.target.value),style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("input",{type:"file",ref:X,style:{width:80}}),n.jsx("button",{onClick:le,className:"btn",children:"Up"})]}),n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",value:B,onChange:e=>G(e.target.value),placeholder:"Type text...",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("button",{onClick:fe,className:"btn",children:"Type"}),n.jsx("button",{onClick:()=>h([{type:"press",key:"Enter"}]),className:"btn",children:"Ent"})]}),n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",value:b,onChange:e=>re(e.target.value),placeholder:"CSS Selector",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("button",{onClick:()=>b&&h([{type:"locate",selector:b}]),className:"btn",children:"Loc"}),n.jsx("button",{onClick:()=>b&&h([{type:"click",selector:b}]),className:"btn",children:"Clk"})]})]}),n.jsxs("div",{style:{fontSize:11,color:"var(--text-secondary)"},children:["DevTools: ",n.jsxs("label",{children:[n.jsx("input",{type:"checkbox",checked:R,onChange:e=>ne(e.target.checked)})," Auto Extract"]})]})]})]})}export{Me as default};

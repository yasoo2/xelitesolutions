import{r as n,j as t,A as R}from"./index-CgaQr4go.js";function me({wsUrl:T}){const b=n.useRef(null),K=n.useRef(null),[i,X]=n.useState({w:1280,h:800}),[M,N]=n.useState("connecting"),[v,Q]=n.useState(""),[_,V]=n.useState([]),[F,w]=n.useState(""),[L,Z]=n.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[O,I]=n.useState(null),[E,ee]=n.useState(""),D=n.useRef(null),[B,j]=n.useState(null),[$,te]=n.useState(!0),[C,U]=n.useState(""),[h,oe]=n.useState(""),[k,q]=n.useState(null),[y,re]=n.useState(""),[x,se]=n.useState(""),[J,ne]=n.useState(!0),[H,ae]=n.useState(!0),[P,le]=n.useState(!0),[W,ce]=n.useState("أضرار التدخين"),Y=n.useRef(0);function z(){try{const a=new URL(T).pathname.split("/").filter(Boolean);return a[a.length-1]}catch{return""}}async function l(e){var d;const a=z();if(a)try{const u=localStorage.getItem("token"),s=await(await fetch(`${R}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...u?{Authorization:`Bearer ${u}`}:{}},body:JSON.stringify({sessionId:a,actions:e})})).json();if(Array.isArray(s.artifacts)){const r=s.artifacts.map(p=>({name:p.name||p.filename||"download",href:p.href}));V(p=>[...r,...p].slice(0,5))}if(s!=null&&s.ok&&Array.isArray((d=s==null?void 0:s.output)==null?void 0:d.outputs)){const r=s.output.outputs.find(p=>p.type==="locate"&&p.boundingBox);if(r!=null&&r.boundingBox&&(q(r.boundingBox),e.some(f=>f.type==="locate")&&H)){const c=[...e].reverse().find(m=>m.type==="locate")||null,S=[];if(c!=null&&c.selector)S.push({type:"click",selector:c.selector});else if(c!=null&&c.role&&(c!=null&&c.roleName))S.push({type:"click",role:c.role,roleName:c.roleName});else{const m=r.boundingBox;if(m){const xe=Math.round(m.x+m.width/2),ge=Math.round(m.y+m.height/2);S.push({type:"click",x:xe,y:ge})}}S.length&&setTimeout(()=>l(S),250);const he=!!(c!=null&&c.selector&&/(input|textarea)\[name=["']q["']\]/i.test(String(c.selector))),ye=!!(c!=null&&c.roleName&&String(c.roleName).includes("بحث"));P&&!C.trim()&&(he||ye)&&setTimeout(()=>{l([{type:"waitForSelector",selector:'input[name="q"], textarea[name="q"]',timeoutMs:8e3}]),setTimeout(()=>l([{type:"type",text:W,delay:30}]),200),setTimeout(()=>l([{type:"press",key:"Enter"}]),300)},400)}}const g=e.map(r=>r.type).join(", ");if(w(g),setTimeout(()=>w(""),1200),e.some(r=>r.type==="goto"||r.type==="reload")&&(q(null),J)){const r=[];if(h)r.push({type:"locate",selector:h});else if(y&&x)r.push({type:"locate",role:y,roleName:x});else{const p=e.find(f=>f.type==="goto");try{const f=p!=null&&p.url?new URL(p.url).hostname:"";f&&/(^|\.)(google)\./i.test(f)&&r.push({type:"locate",selector:'input[name="q"], textarea[name="q"]'})}catch{}}r.length&&setTimeout(()=>l(r),1e3)}$&&e.some(r=>r.type==="press"&&r.key==="Enter")&&setTimeout(()=>{A()},2e3),$&&e.some(r=>r.type==="goto"||r.type==="reload")&&setTimeout(()=>{A()},1500)}catch{}}async function A(){const e=z();if(e)try{const a=localStorage.getItem("token"),d=JSON.parse(L),o=await(await fetch(`${R}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:`Bearer ${a}`}:{}},body:JSON.stringify({sessionId:e,schema:d})})).json();o!=null&&o.ok&&(o!=null&&o.output)?I(o.output):I(null)}catch{I(null)}}async function ie(){var d,u;const e=z(),a=(u=(d=D.current)==null?void 0:d.files)==null?void 0:u[0];if(!(!e||!a||!E))try{const o=localStorage.getItem("token"),s=new FormData;s.append("file",a),s.append("sessionId",e);const r=await(await fetch(`${R}/files/upload`,{method:"POST",headers:{...o?{Authorization:`Bearer ${o}`}:{}},body:s})).json();if(r&&r._id){const p=`${R}/files/${r._id}/raw`;await l([{type:"uploadFile",selector:E,fileUrl:p}])}}catch{}}n.useEffect(()=>{try{const e=new WebSocket(T);return K.current=e,e.onopen=()=>N("connected"),e.onclose=()=>N("closed"),e.onmessage=a=>{var d,u;try{const o=JSON.parse(a.data);if(o.type==="stream_start"&&X({w:o.w,h:o.h}),o.type==="cursor_move"&&j({x:o.x,y:o.y}),o.type==="cursor_click"){j({x:o.x,y:o.y});const s=document.createElement("div");s.style.cssText=`
              position: absolute;
              left: ${o.x/i.w*100}%;
              top: ${o.y/i.h*100}%;
              width: 20px; height: 20px;
              background: rgba(255, 0, 0, 0.5);
              border-radius: 50%;
              transform: translate(-50%, -50%);
              pointer-events: none;
              z-index: 100;
              transition: opacity 0.5s;
            `,(u=(d=b.current)==null?void 0:d.parentElement)==null||u.appendChild(s),setTimeout(()=>s.remove(),500)}if(o.type==="action_start"&&w(o.action.type),o.type==="action_done"&&setTimeout(()=>w(""),500),o.type==="frame"){const s=new Image;s.onload=()=>{const g=b.current;if(!g)return;g.width=i.w,g.height=i.h,g.getContext("2d").drawImage(s,0,0,i.w,i.h)},s.src="data:image/jpeg;base64,"+o.jpegBase64}}catch{}},()=>{try{e.close()}catch{}}}catch{N("error")}},[T,i.w,i.h]);function de(e){const a=b.current;if(!a)return;const d=a.getBoundingClientRect(),u=Math.round((e.clientX-d.left)*(i.w/d.width)),o=Math.round((e.clientY-d.top)*(i.h/d.height));l([{type:"click",x:u,y:o}]),j({x:u,y:o})}function ue(e){e.preventDefault();const a=Math.round(e.deltaY);l([{type:"scroll",deltaY:a}])}function pe(e){const a=Date.now();if(a-(Y.current||0)<60)return;Y.current=a;const d=b.current;if(!d)return;const u=d.getBoundingClientRect(),o=Math.round((e.clientX-u.left)*(i.w/u.width)),s=Math.round((e.clientY-u.top)*(i.h/u.height));j({x:o,y:s}),l([{type:"mouseMove",x:o,y:s,steps:2}])}function G(){C.trim()&&(l([{type:"type",text:C,delay:30}]),U(""))}return t.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("button",{onClick:()=>l([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),t.jsx("button",{onClick:()=>l([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),t.jsx("button",{onClick:()=>l([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),t.jsx("input",{type:"text",value:v,onChange:e=>Q(e.target.value),onKeyDown:e=>{e.key==="Enter"&&v&&l([{type:"goto",url:v,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>v&&l([{type:"goto",url:v,waitUntil:"domcontentloaded"}]),className:"btn",title:"Go",children:"Go"}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:$,onChange:e=>te(e.target.checked)}),"Auto Extract"]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:M==="connected"?"#22c55e":"#f59e0b"}}),t.jsx("span",{style:{fontSize:12,opacity:.6},children:M}),!!F&&t.jsxs("span",{style:{fontSize:12,opacity:.8},children:["Joe: ",F]})]}),t.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:8,overflow:"hidden",position:"relative"},children:[t.jsx("canvas",{ref:b,onClick:de,onWheel:ue,onMouseMove:pe,style:{width:"100%",height:"auto",display:"block",background:"black",cursor:"crosshair"}}),k&&t.jsx("div",{style:{position:"absolute",left:`${k.x/i.w*100}%`,top:`${k.y/i.h*100}%`,width:`${k.width/i.w*100}%`,height:`${k.height/i.h*100}%`,border:"2px solid rgba(59,130,246,0.9)",boxShadow:"0 0 12px rgba(59,130,246,0.6)",pointerEvents:"none"},title:"Highlight"}),B&&t.jsx("div",{style:{position:"absolute",left:`${B.x/i.w*100}%`,top:`${B.y/i.h*100}%`,transform:"translate(-50%, -50%)",width:16,height:16,borderRadius:"50%",background:"rgba(34,197,94,0.8)",boxShadow:"0 0 12px rgba(34,197,94,0.8)",pointerEvents:"none"},title:"Cursor"})]}),_.length>0&&t.jsx("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:_.map((e,a)=>t.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"var(--text-primary)",textDecoration:"underline"},children:e.name},a))}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector for file input (e.g. input[type=file])",value:E,onChange:e=>ee(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"file",ref:D}),t.jsx("button",{onClick:ie,className:"btn",children:"Upload"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",value:C,onChange:e=>U(e.target.value),placeholder:"Type into focused element...",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"},onKeyDown:e=>{e.key==="Enter"&&G()}}),t.jsx("button",{onClick:G,className:"btn",children:"Type"}),t.jsx("button",{onClick:()=>l([{type:"press",key:"Enter"}]),className:"btn",children:"Enter"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector (مثال: input[name=q])",value:h,onChange:e=>oe(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>h&&l([{type:"locate",selector:h}]),className:"btn",children:"Locate"}),t.jsx("button",{onClick:()=>h&&l([{type:"click",selector:h}]),className:"btn",children:"اضغط المحدد"}),t.jsx("button",{onClick:()=>h&&l([{type:"scrollTo",selector:h}]),className:"btn",children:"Scroll إلى المحدد"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"role (مثال: button)",value:y,onChange:e=>re(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"text",placeholder:"name (مثال: بحث)",value:x,onChange:e=>se(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>y&&x&&l([{type:"locate",role:y,roleName:x}]),className:"btn",children:"Locate (role/name)"}),t.jsx("button",{onClick:()=>y&&x&&l([{type:"click",role:y,roleName:x}]),className:"btn",children:"اضغط (role/name)"}),t.jsx("button",{onClick:()=>y&&x&&l([{type:"waitForRole",role:y,roleName:x}]),className:"btn",children:"انتظر (role/name)"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:J,onChange:e=>ne(e.target.checked)}),"Auto Locate بعد التنقل"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:H,onChange:e=>ae(e.target.checked)}),"Auto Click بعد locate"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:P,onChange:e=>le(e.target.checked)}),"Auto Type بعد التركيز"]}),t.jsx("input",{type:"text",value:W,onChange:e=>ce(e.target.value),placeholder:"نص البحث الافتراضي",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("textarea",{value:L,onChange:e=>Z(e.target.value),placeholder:'{"list":{"selector":"table tr","fields":{"col1":{"selector":"td:nth-child(1)"}}}}',style:{flex:1,minHeight:80,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:A,className:"btn",children:"Extract"})]}),O&&t.jsx("pre",{style:{padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)",maxHeight:200,overflow:"auto"},children:JSON.stringify(O,null,2)})]})}export{me as default};

import{r as s,j as t,A as I}from"./index-1Mj0POUK.js";function ve({wsUrl:B}){const k=s.useRef(null),T=s.useRef(null),[i,V]=s.useState({w:1280,h:800}),[_,$]=s.useState("connecting"),[S,Z]=s.useState(""),[L,ee]=s.useState([]),[U,v]=s.useState(""),[D,te]=s.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[q,A]=s.useState(null),[M,oe]=s.useState(""),J=s.useRef(null),[z,N]=s.useState(null),[w,re]=s.useState(!0),[E,W]=s.useState(""),[x,se]=s.useState(""),[j,P]=s.useState(null),[g,ne]=s.useState(""),[f,ae]=s.useState(""),[H,le]=s.useState(!0),[Y,ce]=s.useState(!0),[G,ie]=s.useState(!0),[K,de]=s.useState("أضرار التدخين"),X=s.useRef(0);function O(){try{const n=new URL(B).pathname.split("/").filter(Boolean);return n[n.length-1]}catch{return""}}async function a(e){var o;const n=O();if(!n)return;const d=["mouseMove","click","scroll","type","press","goBack","goForward","reload"];if(T.current&&T.current.readyState===WebSocket.OPEN&&e.every(l=>d.includes(l.type))){e.forEach(y=>{var u;(u=T.current)==null||u.send(JSON.stringify({type:"action",action:y}))});const l=e.map(y=>y.type).join(", ");v(l),setTimeout(()=>v(""),1200),w&&e.some(y=>y.type==="press"&&y.key==="Enter")&&setTimeout(()=>C(),2e3),w&&e.some(y=>y.type==="reload")&&setTimeout(()=>C(),1500);return}try{const l=localStorage.getItem("token"),u=await(await fetch(`${I}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...l?{Authorization:`Bearer ${l}`}:{}},body:JSON.stringify({sessionId:n,actions:e})})).json();if(Array.isArray(u.artifacts)){const r=u.artifacts.map(h=>({name:h.name||h.filename||"download",href:h.href}));ee(h=>[...r,...h].slice(0,5))}if(u!=null&&u.ok&&Array.isArray((o=u==null?void 0:u.output)==null?void 0:o.outputs)){const r=u.output.outputs.find(h=>h.type==="locate"&&h.boundingBox);if(r!=null&&r.boundingBox&&(P(r.boundingBox),e.some(m=>m.type==="locate")&&Y)){const c=[...e].reverse().find(b=>b.type==="locate")||null,R=[];if(c!=null&&c.selector)R.push({type:"click",selector:c.selector});else if(c!=null&&c.role&&(c!=null&&c.roleName))R.push({type:"click",role:c.role,roleName:c.roleName});else{const b=r.boundingBox;if(b){const fe=Math.round(b.x+b.width/2),me=Math.round(b.y+b.height/2);R.push({type:"click",x:fe,y:me})}}R.length&&setTimeout(()=>a(R),250);const xe=!!(c!=null&&c.selector&&/(input|textarea)\[name=["']q["']\]/i.test(String(c.selector))),ge=!!(c!=null&&c.roleName&&String(c.roleName).includes("بحث"));G&&!E.trim()&&(xe||ge)&&setTimeout(()=>{a([{type:"waitForSelector",selector:'input[name="q"], textarea[name="q"]',timeoutMs:8e3}]),setTimeout(()=>a([{type:"type",text:K,delay:30}]),200),setTimeout(()=>a([{type:"press",key:"Enter"}]),300)},400)}}const F=e.map(r=>r.type).join(", ");if(v(F),setTimeout(()=>v(""),1200),e.some(r=>r.type==="goto"||r.type==="reload")&&(P(null),H)){const r=[];if(x)r.push({type:"locate",selector:x});else if(g&&f)r.push({type:"locate",role:g,roleName:f});else{const h=e.find(m=>m.type==="goto");try{const m=h!=null&&h.url?new URL(h.url).hostname:"";m&&/(^|\.)(google)\./i.test(m)&&r.push({type:"locate",selector:'input[name="q"], textarea[name="q"]'})}catch{}}r.length&&setTimeout(()=>a(r),1e3)}w&&e.some(r=>r.type==="press"&&r.key==="Enter")&&setTimeout(()=>{C()},2e3),w&&e.some(r=>r.type==="goto"||r.type==="reload")&&setTimeout(()=>{C()},1500)}catch{}}async function C(){const e=O();if(e)try{const n=localStorage.getItem("token"),d=JSON.parse(D),o=await(await fetch(`${I}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...n?{Authorization:`Bearer ${n}`}:{}},body:JSON.stringify({sessionId:e,schema:d})})).json();o!=null&&o.ok&&(o!=null&&o.output)?A(o.output):A(null)}catch{A(null)}}async function ue(){var d,p;const e=O(),n=(p=(d=J.current)==null?void 0:d.files)==null?void 0:p[0];if(!(!e||!n||!M))try{const o=localStorage.getItem("token"),l=new FormData;l.append("file",n),l.append("sessionId",e);const u=await(await fetch(`${I}/files/upload`,{method:"POST",headers:{...o?{Authorization:`Bearer ${o}`}:{}},body:l})).json();if(u&&u._id){const F=`${I}/files/${u._id}/raw`;await a([{type:"uploadFile",selector:M,fileUrl:F}])}}catch{}}s.useEffect(()=>{try{const e=new WebSocket(B);return T.current=e,e.onopen=()=>$("connected"),e.onclose=()=>$("closed"),e.onmessage=n=>{var d,p;try{const o=JSON.parse(n.data);if(o.type==="stream_start"&&V({w:o.w,h:o.h}),o.type==="cursor_move"&&N({x:o.x,y:o.y}),o.type==="cursor_click"){N({x:o.x,y:o.y});const l=document.createElement("div");l.style.cssText=`
              position: absolute;
              left: ${o.x/i.w*100}%;
              top: ${o.y/i.h*100}%;
              width: 20px; height: 20px;
              background: rgba(255, 0, 0, 0.5);
              border-radius: 50%;
              transform: translate(-50%, -50%);
              pointer-events: none;
              z-index: 100;
              transition: opacity 0.5s;
            `,(p=(d=k.current)==null?void 0:d.parentElement)==null||p.appendChild(l),setTimeout(()=>l.remove(),500)}if(o.type==="action_start"&&v(o.action.type),o.type==="action_done"&&setTimeout(()=>v(""),500),o.type==="frame"){const l=new Image;l.onload=()=>{const y=k.current;if(!y)return;y.width=i.w,y.height=i.h,y.getContext("2d").drawImage(l,0,0,i.w,i.h)},l.src="data:image/jpeg;base64,"+o.jpegBase64}}catch{}},()=>{try{e.close()}catch{}}}catch{$("error")}},[B,i.w,i.h]);function pe(e){const n=k.current;if(!n)return;const d=n.getBoundingClientRect(),p=Math.round((e.clientX-d.left)*(i.w/d.width)),o=Math.round((e.clientY-d.top)*(i.h/d.height));a([{type:"click",x:p,y:o}]),N({x:p,y:o})}function ye(e){e.preventDefault();const n=Math.round(e.deltaY);a([{type:"scroll",deltaY:n}])}function he(e){const n=Date.now();if(n-(X.current||0)<60)return;X.current=n;const d=k.current;if(!d)return;const p=d.getBoundingClientRect(),o=Math.round((e.clientX-p.left)*(i.w/p.width)),l=Math.round((e.clientY-p.top)*(i.h/p.height));N({x:o,y:l}),a([{type:"mouseMove",x:o,y:l,steps:2}])}function Q(){E.trim()&&(a([{type:"type",text:E,delay:30}]),W(""))}return t.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("button",{onClick:()=>a([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),t.jsx("button",{onClick:()=>a([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),t.jsx("button",{onClick:()=>a([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),t.jsx("input",{type:"text",value:S,onChange:e=>Z(e.target.value),onKeyDown:e=>{e.key==="Enter"&&S&&a([{type:"goto",url:S,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>S&&a([{type:"goto",url:S,waitUntil:"domcontentloaded"}]),className:"btn",title:"Go",children:"Go"}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:w,onChange:e=>re(e.target.checked)}),"Auto Extract"]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:_==="connected"?"#22c55e":"#f59e0b"}}),t.jsx("span",{style:{fontSize:12,opacity:.6},children:_}),!!U&&t.jsxs("span",{style:{fontSize:12,opacity:.8},children:["Joe: ",U]})]}),t.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:8,overflow:"hidden",position:"relative"},children:[t.jsx("canvas",{ref:k,onClick:pe,onWheel:ye,onMouseMove:he,style:{width:"100%",height:"auto",display:"block",background:"black",cursor:"crosshair"}}),j&&t.jsx("div",{style:{position:"absolute",left:`${j.x/i.w*100}%`,top:`${j.y/i.h*100}%`,width:`${j.width/i.w*100}%`,height:`${j.height/i.h*100}%`,border:"2px solid rgba(59,130,246,0.9)",boxShadow:"0 0 12px rgba(59,130,246,0.6)",pointerEvents:"none"},title:"Highlight"}),z&&t.jsx("div",{style:{position:"absolute",left:`${z.x/i.w*100}%`,top:`${z.y/i.h*100}%`,transform:"translate(-50%, -50%)",width:16,height:16,borderRadius:"50%",background:"rgba(34,197,94,0.8)",boxShadow:"0 0 12px rgba(34,197,94,0.8)",pointerEvents:"none"},title:"Cursor"})]}),L.length>0&&t.jsx("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:L.map((e,n)=>t.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"var(--text-primary)",textDecoration:"underline"},children:e.name},n))}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector for file input (e.g. input[type=file])",value:M,onChange:e=>oe(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"file",ref:J}),t.jsx("button",{onClick:ue,className:"btn",children:"Upload"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",value:E,onChange:e=>W(e.target.value),placeholder:"Type into focused element...",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"},onKeyDown:e=>{e.key==="Enter"&&Q()}}),t.jsx("button",{onClick:Q,className:"btn",children:"Type"}),t.jsx("button",{onClick:()=>a([{type:"press",key:"Enter"}]),className:"btn",children:"Enter"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"CSS selector (مثال: input[name=q])",value:x,onChange:e=>se(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>x&&a([{type:"locate",selector:x}]),className:"btn",children:"Locate"}),t.jsx("button",{onClick:()=>x&&a([{type:"click",selector:x}]),className:"btn",children:"اضغط المحدد"}),t.jsx("button",{onClick:()=>x&&a([{type:"scrollTo",selector:x}]),className:"btn",children:"Scroll إلى المحدد"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"text",placeholder:"role (مثال: button)",value:g,onChange:e=>ne(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("input",{type:"text",placeholder:"name (مثال: بحث)",value:f,onChange:e=>ae(e.target.value),style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>g&&f&&a([{type:"locate",role:g,roleName:f}]),className:"btn",children:"Locate (role/name)"}),t.jsx("button",{onClick:()=>g&&f&&a([{type:"click",role:g,roleName:f}]),className:"btn",children:"اضغط (role/name)"}),t.jsx("button",{onClick:()=>g&&f&&a([{type:"waitForRole",role:g,roleName:f}]),className:"btn",children:"انتظر (role/name)"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:H,onChange:e=>le(e.target.checked)}),"Auto Locate بعد التنقل"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:Y,onChange:e=>ce(e.target.checked)}),"Auto Click بعد locate"]}),t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:12},children:[t.jsx("input",{type:"checkbox",checked:G,onChange:e=>ie(e.target.checked)}),"Auto Type بعد التركيز"]}),t.jsx("input",{type:"text",value:K,onChange:e=>de(e.target.value),placeholder:"نص البحث الافتراضي",style:{flex:1,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("textarea",{value:D,onChange:e=>te(e.target.value),placeholder:'{"list":{"selector":"table tr","fields":{"col1":{"selector":"td:nth-child(1)"}}}}',style:{flex:1,minHeight:80,padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:C,className:"btn",children:"Extract"})]}),q&&t.jsx("pre",{style:{padding:8,borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-secondary)",color:"var(--text-primary)",maxHeight:200,overflow:"auto"},children:JSON.stringify(q,null,2)})]})}export{ve as default};

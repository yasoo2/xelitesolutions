import{r as a,j as n,A as $}from"./index-DaAiEazo.js";function Ce({wsUrl:I}){const f=a.useRef(null),C=a.useRef(null),[h,X]=a.useState({w:1280,h:800}),T=a.useRef({w:1280,h:800}),[R,z]=a.useState("connecting"),[w,G]=a.useState(""),[F,H]=a.useState([]),[W,b]=a.useState(""),[K,xe]=a.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[ge,A]=a.useState(null),[D,V]=a.useState(""),L=a.useRef(null),[O,v]=a.useState(null),[S,Q]=a.useState(!0),[N,q]=a.useState(""),[x,Z]=a.useState(""),[k,Y]=a.useState(null),[J,me]=a.useState(""),[P,be]=a.useState(""),[ee,ve]=a.useState(!0),[te,we]=a.useState(!0),[oe,Se]=a.useState(!0),[ne,ke]=a.useState("أضرار التدخين"),E=a.useRef(0);a.useEffect(()=>{T.current=h},[h]);function U(){try{const r=new URL(I).pathname.split("/").filter(Boolean);return r[r.length-1]}catch{return""}}async function u(e){var t;const r=U();if(!r)return;const c=["mouseMove","click","scroll","type","press","goBack","goForward","reload"];if(C.current&&C.current.readyState===WebSocket.OPEN&&e.every(o=>c.includes(o.type))){e.forEach(s=>{var l;(l=C.current)==null||l.send(JSON.stringify({type:"action",action:s}))});const o=e.map(s=>s.type).join(", ");b(o),setTimeout(()=>b(""),1200),S&&e.some(s=>s.type==="press"&&s.key==="Enter")&&setTimeout(()=>M(),2e3),S&&e.some(s=>s.type==="reload")&&setTimeout(()=>M(),1500);return}try{const o=localStorage.getItem("token"),l=await(await fetch(`${$}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...o?{Authorization:`Bearer ${o}`}:{}},body:JSON.stringify({sessionId:r,actions:e})})).json();if(Array.isArray(l.artifacts)){const d=l.artifacts.map(y=>({name:y.name||y.filename||"download",href:y.href}));H(y=>[...d,...y].slice(0,5))}if(l!=null&&l.ok&&Array.isArray((t=l==null?void 0:l.output)==null?void 0:t.outputs)){const d=l.output.outputs.find(y=>y.type==="locate"&&y.boundingBox);if(d!=null&&d.boundingBox&&(Y(d.boundingBox),e.some(g=>g.type==="locate")&&te)){const p=[...e].reverse().find(m=>m.type==="locate")||null,j=[];if(p!=null&&p.selector)j.push({type:"click",selector:p.selector});else if(p!=null&&p.role&&(p!=null&&p.roleName))j.push({type:"click",role:p.role,roleName:p.roleName});else{const m=d.boundingBox;if(m){const ye=Math.round(m.x+m.width/2),fe=Math.round(m.y+m.height/2);j.push({type:"click",x:ye,y:fe})}}j.length&&setTimeout(()=>u(j),250);const pe=!!(p!=null&&p.selector&&/(input|textarea)\[name=["']q["']\]/i.test(String(p.selector))),he=!!(p!=null&&p.roleName&&String(p.roleName).includes("بحث"));oe&&!N.trim()&&(pe||he)&&setTimeout(()=>{u([{type:"waitForSelector",selector:'input[name="q"], textarea[name="q"]',timeoutMs:8e3}]),setTimeout(()=>u([{type:"type",text:ne,delay:30}]),200),setTimeout(()=>u([{type:"press",key:"Enter"}]),300)},400)}}const B=e.map(d=>d.type).join(", ");if(b(B),setTimeout(()=>b(""),1200),e.some(d=>d.type==="goto"||d.type==="reload")&&(Y(null),ee)){const d=[];if(x)d.push({type:"locate",selector:x});else if(J&&P)d.push({type:"locate",role:J,roleName:P});else{const y=e.find(g=>g.type==="goto");try{const g=y!=null&&y.url?new URL(y.url).hostname:"";g&&/(^|\.)(google)\./i.test(g)&&d.push({type:"locate",selector:'input[name="q"], textarea[name="q"]'})}catch{}}d.length&&setTimeout(()=>u(d),1e3)}S&&e.some(d=>d.type==="press"&&d.key==="Enter")&&setTimeout(()=>{M()},2e3),S&&e.some(d=>d.type==="goto"||d.type==="reload")&&setTimeout(()=>{M()},1500)}catch{}}async function M(){const e=U();if(e)try{const r=localStorage.getItem("token"),c=JSON.parse(K),t=await(await fetch(`${$}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...r?{Authorization:`Bearer ${r}`}:{}},body:JSON.stringify({sessionId:e,schema:c})})).json();t!=null&&t.ok&&(t!=null&&t.output)?A(t.output):A(null)}catch{A(null)}}async function se(){var c,i;const e=U(),r=(i=(c=L.current)==null?void 0:c.files)==null?void 0:i[0];if(!(!e||!r||!D))try{const t=localStorage.getItem("token"),o=new FormData;o.append("file",r),o.append("sessionId",e);const l=await(await fetch(`${$}/files/upload`,{method:"POST",headers:{...t?{Authorization:`Bearer ${t}`}:{}},body:o})).json();if(l&&l._id){const B=`${$}/files/${l._id}/raw`;await u([{type:"uploadFile",selector:D,fileUrl:B}])}}catch{}}a.useEffect(()=>{try{const e=new WebSocket(I);return C.current=e,e.onopen=()=>z("connected"),e.onclose=()=>z("closed"),e.onmessage=r=>{var c,i;try{const t=JSON.parse(r.data);if(t.type==="stream_start"){const o={w:t.w,h:t.h};T.current=o,X(o)}if(t.type==="cursor_move"&&v({x:t.x,y:t.y}),t.type==="cursor_click"){v({x:t.x,y:t.y});const o=document.createElement("div"),s=T.current;o.style.cssText=`
              position: absolute;
              left: ${t.x/s.w*100}%;
              top: ${t.y/s.h*100}%;
              width: 20px; height: 20px;
              background: rgba(255, 0, 0, 0.5);
              border-radius: 50%;
              transform: translate(-50%, -50%);
              pointer-events: none;
              z-index: 100;
              transition: opacity 0.5s;
            `,(i=(c=f.current)==null?void 0:c.parentElement)==null||i.appendChild(o),setTimeout(()=>o.remove(),500)}if(t.type==="action_start"){const o=t.action;let s=o.type;o.type==="goto"&&(s=`Opening ${new URL(o.url).hostname}...`),o.type==="type"&&(s="Typing..."),o.type==="click"&&(s="Clicking..."),o.type==="scroll"&&(s="Scrolling..."),o.type==="screenshot"&&(s="Capturing View..."),b(s)}if(t.type==="action_done"&&setTimeout(()=>b(""),500),t.type==="frame"){const o=new Image;o.onload=()=>{const s=f.current;if(!s)return;const l=T.current;s.width=l.w,s.height=l.h,s.getContext("2d").drawImage(o,0,0,l.w,l.h)},o.src="data:image/jpeg;base64,"+t.jpegBase64}}catch{}},()=>{try{e.close()}catch{}}}catch{z("error")}},[I]);function re(e){const r=f.current;if(!r)return;const c=r.getBoundingClientRect(),i=Math.round((e.clientX-c.left)*(h.w/c.width)),t=Math.round((e.clientY-c.top)*(h.h/c.height));u([{type:"click",x:i,y:t}]),v({x:i,y:t})}function ae(e){e.preventDefault();const r=Math.round(e.deltaY);u([{type:"scroll",deltaY:r}])}function ce(e){const r=Date.now();if(r-(E.current||0)<60)return;E.current=r;const c=f.current;if(!c)return;const i=c.getBoundingClientRect(),t=Math.round((e.clientX-i.left)*(h.w/i.width)),o=Math.round((e.clientY-i.top)*(h.h/i.height));v({x:t,y:o}),u([{type:"mouseMove",x:t,y:o,steps:2}])}function ie(e){var s;const r=f.current,c=(s=e.touches)==null?void 0:s[0];if(!r||!c)return;e.preventDefault();const i=r.getBoundingClientRect(),t=Math.round((c.clientX-i.left)*(h.w/i.width)),o=Math.round((c.clientY-i.top)*(h.h/i.height));u([{type:"click",x:t,y:o}]),v({x:t,y:o})}function le(e){var l;const r=Date.now();if(r-(E.current||0)<60)return;E.current=r;const c=f.current,i=(l=e.touches)==null?void 0:l[0];if(!c||!i)return;e.preventDefault();const t=c.getBoundingClientRect(),o=Math.round((i.clientX-t.left)*(h.w/t.width)),s=Math.round((i.clientY-t.top)*(h.h/t.height));v({x:o,y:s}),u([{type:"mouseMove",x:o,y:s,steps:2}])}function de(){N.trim()&&(u([{type:"type",text:N,delay:30}]),q(""))}const[_,ue]=a.useState(!1);return n.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8,position:"relative"},children:[n.jsxs("div",{className:"agent-browser-header",style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",background:"var(--bg-secondary)",borderRadius:8,gap:8,flexWrap:"wrap"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[n.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:R==="connected"?"#22c55e":"#ef4444",boxShadow:R==="connected"?"0 0 8px #22c55e":"none"}}),n.jsx("span",{style:{fontSize:14,fontWeight:500,color:"var(--text-primary)"},children:R==="connected"?"Agent Connected":R})]}),W&&n.jsxs("div",{style:{padding:"4px 12px",background:"rgba(59, 130, 246, 0.15)",border:"1px solid rgba(59, 130, 246, 0.3)",borderRadius:16,color:"#60a5fa",fontSize:12,display:"flex",alignItems:"center",gap:6},children:[n.jsx("span",{className:"animate-pulse",children:"●"}),W]}),n.jsx("button",{onClick:()=>ue(!_),style:{background:"transparent",border:"none",color:"var(--text-secondary)",cursor:"pointer",fontSize:12},children:_?"Hide Controls":"Show Controls"})]}),n.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:12,overflow:"hidden",position:"relative",background:"#000",boxShadow:"0 4px 20px rgba(0,0,0,0.3)"},children:[n.jsx("canvas",{ref:f,onClick:re,onWheel:ae,onMouseMove:ce,onTouchStart:ie,onTouchMove:le,style:{width:"100%",height:"auto",display:"block",cursor:"default",touchAction:"none"}}),k&&n.jsx("div",{style:{position:"absolute",left:`${k.x/h.w*100}%`,top:`${k.y/h.h*100}%`,width:`${k.width/h.w*100}%`,height:`${k.height/h.h*100}%`,border:"2px solid #eab308",boxShadow:"0 0 15px rgba(234, 179, 8, 0.4)",pointerEvents:"none",borderRadius:4,transition:"all 0.2s ease"}}),O&&n.jsx("div",{style:{position:"absolute",left:`${O.x/h.w*100}%`,top:`${O.y/h.h*100}%`,transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:50,transition:"all 0.1s linear"},children:n.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#eab308",border:"2px solid white",boxShadow:"0 2px 4px rgba(0,0,0,0.3)"}})})]}),F.length>0&&n.jsxs("div",{style:{display:"flex",gap:8,padding:8,background:"var(--bg-secondary)",borderRadius:8},children:[n.jsx("span",{style:{fontSize:12,color:"var(--text-secondary)"},children:"Downloads:"}),F.map((e,r)=>n.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"#3b82f6"},children:e.name},r))]}),_&&n.jsxs("div",{style:{padding:12,border:"1px solid var(--border-color)",borderRadius:8,background:"var(--bg-secondary)",display:"flex",flexDirection:"column",gap:12},children:[n.jsxs("div",{className:"agent-browser-controls-row",style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[n.jsx("button",{onClick:()=>u([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),n.jsx("button",{onClick:()=>u([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),n.jsx("button",{onClick:()=>u([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),n.jsx("input",{type:"text",value:w,onChange:e=>G(e.target.value),onKeyDown:e=>{e.key==="Enter"&&w&&u([{type:"goto",url:w,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,minWidth:220,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-primary)",color:"var(--text-primary)"}}),n.jsx("button",{onClick:()=>w&&u([{type:"goto",url:w,waitUntil:"domcontentloaded"}]),className:"btn",children:"Go"})]}),n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:8},children:[n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",placeholder:"Upload Selector",value:D,onChange:e=>V(e.target.value),style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("input",{type:"file",ref:L,style:{width:80}}),n.jsx("button",{onClick:se,className:"btn",children:"Up"})]}),n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",value:N,onChange:e=>q(e.target.value),placeholder:"Type text...",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("button",{onClick:de,className:"btn",children:"Type"}),n.jsx("button",{onClick:()=>u([{type:"press",key:"Enter"}]),className:"btn",children:"Ent"})]}),n.jsxs("div",{style:{display:"flex",gap:4},children:[n.jsx("input",{type:"text",value:x,onChange:e=>Z(e.target.value),placeholder:"CSS Selector",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),n.jsx("button",{onClick:()=>x&&u([{type:"locate",selector:x}]),className:"btn",children:"Loc"}),n.jsx("button",{onClick:()=>x&&u([{type:"click",selector:x}]),className:"btn",children:"Clk"})]})]}),n.jsxs("div",{style:{fontSize:11,color:"var(--text-secondary)"},children:["DevTools: ",n.jsxs("label",{children:[n.jsx("input",{type:"checkbox",checked:S,onChange:e=>Q(e.target.checked)})," Auto Extract"]})]})]})]})}export{Ce as default};

import{r as n,j as t,A as E}from"./index-JR3o1tk1.js";function Se({wsUrl:B}){const b=n.useRef(null),j=n.useRef(null),[c,Y]=n.useState({w:1280,h:800}),[C,$]=n.useState("connecting"),[v,G]=n.useState(""),[_,H]=n.useState([]),[D,m]=n.useState(""),[X,ye]=n.useState('{"list":{"selector":"a[href^=\\"https\\"]:not([href*=\\"google.com\\"])","fields":{"text":{"selector":"","attr":""},"url":{"selector":"","attr":"href"}}}}'),[he,I]=n.useState(null),[M,K]=n.useState(""),F=n.useRef(null),[z,T]=n.useState(null),[w,V]=n.useState(!0),[R,L]=n.useState(""),[x,Q]=n.useState(""),[S,W]=n.useState(null),[q,xe]=n.useState(""),[J,fe]=n.useState(""),[Z,ge]=n.useState(!0),[ee,me]=n.useState(!0),[te,be]=n.useState(!0),[oe,ve]=n.useState("أضرار التدخين"),P=n.useRef(0);function A(){try{const a=new URL(B).pathname.split("/").filter(Boolean);return a[a.length-1]}catch{return""}}async function d(e){var o;const a=A();if(!a)return;const u=["mouseMove","click","scroll","type","press","goBack","goForward","reload"];if(j.current&&j.current.readyState===WebSocket.OPEN&&e.every(s=>u.includes(s.type))){e.forEach(l=>{var p;(p=j.current)==null||p.send(JSON.stringify({type:"action",action:l}))});const s=e.map(l=>l.type).join(", ");m(s),setTimeout(()=>m(""),1200),w&&e.some(l=>l.type==="press"&&l.key==="Enter")&&setTimeout(()=>N(),2e3),w&&e.some(l=>l.type==="reload")&&setTimeout(()=>N(),1500);return}try{const s=localStorage.getItem("token"),p=await(await fetch(`${E}/tools/browser_run/execute`,{method:"POST",headers:{"Content-Type":"application/json",...s?{Authorization:`Bearer ${s}`}:{}},body:JSON.stringify({sessionId:a,actions:e})})).json();if(Array.isArray(p.artifacts)){const r=p.artifacts.map(h=>({name:h.name||h.filename||"download",href:h.href}));H(h=>[...r,...h].slice(0,5))}if(p!=null&&p.ok&&Array.isArray((o=p==null?void 0:p.output)==null?void 0:o.outputs)){const r=p.output.outputs.find(h=>h.type==="locate"&&h.boundingBox);if(r!=null&&r.boundingBox&&(W(r.boundingBox),e.some(f=>f.type==="locate")&&ee)){const i=[...e].reverse().find(g=>g.type==="locate")||null,k=[];if(i!=null&&i.selector)k.push({type:"click",selector:i.selector});else if(i!=null&&i.role&&(i!=null&&i.roleName))k.push({type:"click",role:i.role,roleName:i.roleName});else{const g=r.boundingBox;if(g){const ue=Math.round(g.x+g.width/2),pe=Math.round(g.y+g.height/2);k.push({type:"click",x:ue,y:pe})}}k.length&&setTimeout(()=>d(k),250);const ce=!!(i!=null&&i.selector&&/(input|textarea)\[name=["']q["']\]/i.test(String(i.selector))),de=!!(i!=null&&i.roleName&&String(i.roleName).includes("بحث"));te&&!R.trim()&&(ce||de)&&setTimeout(()=>{d([{type:"waitForSelector",selector:'input[name="q"], textarea[name="q"]',timeoutMs:8e3}]),setTimeout(()=>d([{type:"type",text:oe,delay:30}]),200),setTimeout(()=>d([{type:"press",key:"Enter"}]),300)},400)}}const U=e.map(r=>r.type).join(", ");if(m(U),setTimeout(()=>m(""),1200),e.some(r=>r.type==="goto"||r.type==="reload")&&(W(null),Z)){const r=[];if(x)r.push({type:"locate",selector:x});else if(q&&J)r.push({type:"locate",role:q,roleName:J});else{const h=e.find(f=>f.type==="goto");try{const f=h!=null&&h.url?new URL(h.url).hostname:"";f&&/(^|\.)(google)\./i.test(f)&&r.push({type:"locate",selector:'input[name="q"], textarea[name="q"]'})}catch{}}r.length&&setTimeout(()=>d(r),1e3)}w&&e.some(r=>r.type==="press"&&r.key==="Enter")&&setTimeout(()=>{N()},2e3),w&&e.some(r=>r.type==="goto"||r.type==="reload")&&setTimeout(()=>{N()},1500)}catch{}}async function N(){const e=A();if(e)try{const a=localStorage.getItem("token"),u=JSON.parse(X),o=await(await fetch(`${E}/tools/browser_extract/execute`,{method:"POST",headers:{"Content-Type":"application/json",...a?{Authorization:`Bearer ${a}`}:{}},body:JSON.stringify({sessionId:e,schema:u})})).json();o!=null&&o.ok&&(o!=null&&o.output)?I(o.output):I(null)}catch{I(null)}}async function se(){var u,y;const e=A(),a=(y=(u=F.current)==null?void 0:u.files)==null?void 0:y[0];if(!(!e||!a||!M))try{const o=localStorage.getItem("token"),s=new FormData;s.append("file",a),s.append("sessionId",e);const p=await(await fetch(`${E}/files/upload`,{method:"POST",headers:{...o?{Authorization:`Bearer ${o}`}:{}},body:s})).json();if(p&&p._id){const U=`${E}/files/${p._id}/raw`;await d([{type:"uploadFile",selector:M,fileUrl:U}])}}catch{}}n.useEffect(()=>{try{const e=new WebSocket(B);return j.current=e,e.onopen=()=>$("connected"),e.onclose=()=>$("closed"),e.onmessage=a=>{var u,y;try{const o=JSON.parse(a.data);if(o.type==="stream_start"&&Y({w:o.w,h:o.h}),o.type==="cursor_move"&&T({x:o.x,y:o.y}),o.type==="cursor_click"){T({x:o.x,y:o.y});const s=document.createElement("div");s.style.cssText=`
              position: absolute;
              left: ${o.x/c.w*100}%;
              top: ${o.y/c.h*100}%;
              width: 20px; height: 20px;
              background: rgba(255, 0, 0, 0.5);
              border-radius: 50%;
              transform: translate(-50%, -50%);
              pointer-events: none;
              z-index: 100;
              transition: opacity 0.5s;
            `,(y=(u=b.current)==null?void 0:u.parentElement)==null||y.appendChild(s),setTimeout(()=>s.remove(),500)}if(o.type==="action_start"){const s=o.action;let l=s.type;s.type==="goto"&&(l=`Opening ${new URL(s.url).hostname}...`),s.type==="type"&&(l="Typing..."),s.type==="click"&&(l="Clicking..."),s.type==="scroll"&&(l="Scrolling..."),s.type==="screenshot"&&(l="Capturing View..."),m(l)}if(o.type==="action_done"&&setTimeout(()=>m(""),500),o.type==="frame"){const s=new Image;s.onload=()=>{const l=b.current;if(!l)return;l.width=c.w,l.height=c.h,l.getContext("2d").drawImage(s,0,0,c.w,c.h)},s.src="data:image/jpeg;base64,"+o.jpegBase64}}catch{}},()=>{try{e.close()}catch{}}}catch{$("error")}},[B,c.w,c.h]);function ne(e){const a=b.current;if(!a)return;const u=a.getBoundingClientRect(),y=Math.round((e.clientX-u.left)*(c.w/u.width)),o=Math.round((e.clientY-u.top)*(c.h/u.height));d([{type:"click",x:y,y:o}]),T({x:y,y:o})}function re(e){e.preventDefault();const a=Math.round(e.deltaY);d([{type:"scroll",deltaY:a}])}function ae(e){const a=Date.now();if(a-(P.current||0)<60)return;P.current=a;const u=b.current;if(!u)return;const y=u.getBoundingClientRect(),o=Math.round((e.clientX-y.left)*(c.w/y.width)),s=Math.round((e.clientY-y.top)*(c.h/y.height));T({x:o,y:s}),d([{type:"mouseMove",x:o,y:s,steps:2}])}function le(){R.trim()&&(d([{type:"type",text:R,delay:30}]),L(""))}const[O,ie]=n.useState(!1);return t.jsxs("div",{className:"agent-browser-stream",style:{display:"flex",flexDirection:"column",gap:8,position:"relative"},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 12px",background:"var(--bg-secondary)",borderRadius:8},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:C==="connected"?"#22c55e":"#ef4444",boxShadow:C==="connected"?"0 0 8px #22c55e":"none"}}),t.jsx("span",{style:{fontSize:14,fontWeight:500,color:"var(--text-primary)"},children:C==="connected"?"Agent Connected":C})]}),D&&t.jsxs("div",{style:{padding:"4px 12px",background:"rgba(59, 130, 246, 0.15)",border:"1px solid rgba(59, 130, 246, 0.3)",borderRadius:16,color:"#60a5fa",fontSize:12,display:"flex",alignItems:"center",gap:6},children:[t.jsx("span",{className:"animate-pulse",children:"●"}),D]}),t.jsx("button",{onClick:()=>ie(!O),style:{background:"transparent",border:"none",color:"var(--text-secondary)",cursor:"pointer",fontSize:12},children:O?"Hide Controls":"Show Controls"})]}),t.jsxs("div",{style:{border:"1px solid var(--border-color)",borderRadius:12,overflow:"hidden",position:"relative",background:"#000",boxShadow:"0 4px 20px rgba(0,0,0,0.3)"},children:[t.jsx("canvas",{ref:b,onClick:ne,onWheel:re,onMouseMove:ae,style:{width:"100%",height:"auto",display:"block",cursor:"default"}}),S&&t.jsx("div",{style:{position:"absolute",left:`${S.x/c.w*100}%`,top:`${S.y/c.h*100}%`,width:`${S.width/c.w*100}%`,height:`${S.height/c.h*100}%`,border:"2px solid #eab308",boxShadow:"0 0 15px rgba(234, 179, 8, 0.4)",pointerEvents:"none",borderRadius:4,transition:"all 0.2s ease"}}),z&&t.jsx("div",{style:{position:"absolute",left:`${z.x/c.w*100}%`,top:`${z.y/c.h*100}%`,transform:"translate(-50%, -50%)",pointerEvents:"none",zIndex:50,transition:"all 0.1s linear"},children:t.jsx("div",{style:{width:12,height:12,borderRadius:"50%",background:"#eab308",border:"2px solid white",boxShadow:"0 2px 4px rgba(0,0,0,0.3)"}})})]}),_.length>0&&t.jsxs("div",{style:{display:"flex",gap:8,padding:8,background:"var(--bg-secondary)",borderRadius:8},children:[t.jsx("span",{style:{fontSize:12,color:"var(--text-secondary)"},children:"Downloads:"}),_.map((e,a)=>t.jsx("a",{href:e.href,target:"_blank",rel:"noreferrer",style:{fontSize:12,color:"#3b82f6"},children:e.name},a))]}),O&&t.jsxs("div",{style:{padding:12,border:"1px solid var(--border-color)",borderRadius:8,background:"var(--bg-secondary)",display:"flex",flexDirection:"column",gap:12},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("button",{onClick:()=>d([{type:"goBack"}]),className:"btn",title:"Back",children:"⟵"}),t.jsx("button",{onClick:()=>d([{type:"goForward"}]),className:"btn",title:"Forward",children:"⟶"}),t.jsx("button",{onClick:()=>d([{type:"reload"}]),className:"btn",title:"Reload",children:"⟳"}),t.jsx("input",{type:"text",value:v,onChange:e=>G(e.target.value),onKeyDown:e=>{e.key==="Enter"&&v&&d([{type:"goto",url:v,waitUntil:"domcontentloaded"}])},placeholder:"https://example.com",style:{flex:1,padding:"8px 10px",borderRadius:8,border:"1px solid var(--border-color)",background:"var(--bg-primary)",color:"var(--text-primary)"}}),t.jsx("button",{onClick:()=>v&&d([{type:"goto",url:v,waitUntil:"domcontentloaded"}]),className:"btn",children:"Go"})]}),t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:8},children:[t.jsxs("div",{style:{display:"flex",gap:4},children:[t.jsx("input",{type:"text",placeholder:"Upload Selector",value:M,onChange:e=>K(e.target.value),style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),t.jsx("input",{type:"file",ref:F,style:{width:80}}),t.jsx("button",{onClick:se,className:"btn",children:"Up"})]}),t.jsxs("div",{style:{display:"flex",gap:4},children:[t.jsx("input",{type:"text",value:R,onChange:e=>L(e.target.value),placeholder:"Type text...",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),t.jsx("button",{onClick:le,className:"btn",children:"Type"}),t.jsx("button",{onClick:()=>d([{type:"press",key:"Enter"}]),className:"btn",children:"Ent"})]}),t.jsxs("div",{style:{display:"flex",gap:4},children:[t.jsx("input",{type:"text",value:x,onChange:e=>Q(e.target.value),placeholder:"CSS Selector",style:{flex:1,padding:4,borderRadius:4,border:"1px solid var(--border-color)"}}),t.jsx("button",{onClick:()=>x&&d([{type:"locate",selector:x}]),className:"btn",children:"Loc"}),t.jsx("button",{onClick:()=>x&&d([{type:"click",selector:x}]),className:"btn",children:"Clk"})]})]}),t.jsxs("div",{style:{fontSize:11,color:"var(--text-secondary)"},children:["DevTools: ",t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:w,onChange:e=>V(e.target.checked)})," Auto Extract"]})]})]})]})}export{Se as default};
